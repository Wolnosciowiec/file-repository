version: org.riotkit.rkd/yaml/v1
imports: []

environment:
    BROWSER_BIN: "chromium"
    BROWSER_DOCKER_IMAGE: "selenium/standalone-chrome:4.0.0-beta-1-prerelease-20210209"

tasks:
    :e2e:test:
        description: Run End-To-End tests with Behat
        steps: ./vendor/bin/behat

    :e2e:install:
        description: Install
        steps: composer install

    #
    # Runs a native browser (without a docker container)
    #
    :e2e:browser:spawn-without-docker:
        description: Run Chromium browser
        steps:
            - rm -rf .rkd/browser-profile
            - $BROWSER_BIN --remote-debugging-address=0.0.0.0 --remote-debugging-port=9222 --user-data-dir=.rkd/browser-profile

    #
    # Spawns a browser inside a docker container
    # We use Selenium's official container, because it is always up-to-date and well maintained
    # but we do not use Selenium itself - just only the Chrome that is installed inside
    #
    :e2e:browser:spawn-container:
        description: Spawns a Google Chrome container
        steps: |
            docker rm -f br_e2e_browser
            docker create --rm --name br_e2e_browser -p 127.0.0.1:9222:9222 -p 127.0.0.1:5900:5900 ${BROWSER_DOCKER_IMAGE}
            chmod +x $(pwd)/.rkd/dockerized-browser/start-selenium-standalone.sh
            docker cp $(pwd)/.rkd/dockerized-browser/start-selenium-standalone.sh br_e2e_browser:/opt/bin/start-selenium-standalone.sh
            docker start br_e2e_browser
