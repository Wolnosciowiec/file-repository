version: org.riotkit.rkd/yaml/v1
imports: []

env_file:
    - ../.env

tasks:
    :docker:up:
        become: root
        description: Runs a dockerized environment
        steps: |
            docker rm -f s3pb_db_1 || true
            docker-compose -p s3pb -f .infrastructure/docker/docker-compose.yml up -d --force-recreate

    :ci:environment:
        description: Setup environment for continuous integration
        steps:
            - cp -pr .infrastructure/ci-files/* ./
            - cat .env
            - "%RKD% :dev"

    :dev:
        description: Prepare development environment
        steps: |
            %RKD% :docker:up
            sleep 10
            composer install
            ./bin/console doctrine:migrations:migrate -n
            symfony serve -d

    :create:keys:
        description: Create JWT encryption keys
        steps:
            - mkdir -p config/jwt
            - openssl genpkey -out config/jwt/private.pem -aes256 -pass pass:$JWT_PASSPHRASE -algorithm rsa -pkeyopt rsa_keygen_bits:4096
            - openssl pkey -in config/jwt/private.pem -out config/jwt/public.pem -pubout -passin pass:$JWT_PASSPHRASE

    :test:api:
        description: Run API tests
        arguments:
            "--filter":
                help: "Execute only selected test case. Examples: Features/Security/FeatureOnlyOneFileAllowedToUploadCest, BackupCollectionListingCest, RegistryListingCest:testListingAllFiles"

        steps: |
            SYMFONY_DEPRECATIONS_HELPER=weak ./vendor/bin/codecept run --html=file-repository.html functional ${ARG_FILTER}
