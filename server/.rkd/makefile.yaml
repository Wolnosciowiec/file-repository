version: org.riotkit.rkd/yaml/v1
imports: []

env_file:
    - ../.env

tasks:
    :docker:up:
        become: root
        description: Runs a dockerized environment
        steps: |
            docker rm -f s3pb_db_1 || true
            docker-compose -p s3pb -f .infrastructure/docker/docker-compose.yml up -d --force-recreate

    :ci:environment:
        description: Setup environment for continuous integration
        steps:
            - cp -pr .infrastructure/ci-files/* ./
            - cp -pr .infrastructure/ci-files/.env ./
            - "%RKD% :dev"

    :dev:
        description: Prepare development environment
        steps: |
            %RKD% :docker:up
            sleep 10
            composer install
            ./bin/console doctrine:migrations:migrate -n
            symfony serve -d

    :create:keys:
        description: Create JWT encryption keys
        steps:
            - mkdir -p config/jwt
            - openssl genpkey -out config/jwt/private.pem -aes256 -pass pass:$JWT_PASSPHRASE -algorithm rsa -pkeyopt rsa_keygen_bits:4096
            - openssl pkey -in config/jwt/private.pem -out config/jwt/public.pem -pubout -passin pass:$JWT_PASSPHRASE

    :test:api:
        description: Run API tests
        arguments:
            "--filter":
                help: "Execute only selected test case. Examples: Features/Security/FeatureOnlyOneFileAllowedToUploadCest, BackupCollectionListingCest, RegistryListingCest:testListingAllFiles"

        steps:
            - mkdir -p var/tests
            - rm ./tests/Functional/_output/*.html 2>/dev/null || true
            - |
                set +e
                SYMFONY_DEPRECATIONS_HELPER=weak ./vendor/bin/codecept run --html=../../../var/tests/api.html --xml=../../../var/tests/api.junit.xml functional ${ARG_FILTER};
                exit_code=$?

                cp -pr ./tests/Functional/_output/* var/tests/ 2>/dev/null
                exit $exit_code

    :test:unit:
        description: Run unit tests
        steps: |
            mkdir -p var/tests
            SYMFONY_DEPRECATIONS_HELPER=weak ./vendor/bin/phpunit --coverage-html=var/tests/coverage

    :test:unit:html:
        description: Create report in HTML format
        steps: vjunit -f var/tests/unit.junit.xml -o var/tests/unit.junit.html
